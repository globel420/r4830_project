# .agent.md - R4830 Controller Workspace Guide

Last updated: 2026-02-08
Workspace root: `/Users/globel/r4830_project`
Primary app: `/Users/globel/r4830_project/swift`

## 1) Purpose
This workspace is for reverse-engineering and controlling the R4830 / ChargeFast BLE charger controller using captured BLE traffic and a Flutter app.

Current product direction:
1. Keep replay and live BLE capability working.
2. Build and iterate the GUI to match the existing OEM ChargeFast app layout.
3. Only promote protocol mappings when evidence exists in captures/logs.

## 2) Non-Negotiables
- Zero hallucinations.
- Mark uncertain items as `TBD`.
- Prefer evidence from:
  - capture artifacts (`att_events.jsonl`, btsnoop)
  - code in this workspace
  - explicit user confirmation
- Do not invent command semantics.
- Do not claim UUID-to-handle mapping unless proven from data.

## 3) Repo Snapshot (Verified)
Top-level directories/files of interest:
- `swift/` -> active Flutter app (macOS + iOS targets)
- `controller/` -> backend scripts, BLE extraction tools, captures
- `agent/generated_code/` -> separate generated Flutter app (Riverpod-based; not the currently run app)
- `remind_codex.txt` -> session resume checklist
- `ble_mapping_notes.txt` -> research notes

Important note:
- `captures/` does **not** currently exist at repo root.
- Actual captures are under: `/Users/globel/r4830_project/controller/captures`

## 4) Active Application (Swift Flutter Project)
Project path: `/Users/globel/r4830_project/swift`

Main entry:
- `/Users/globel/r4830_project/swift/lib/main.dart`

Navigation shell:
- `/Users/globel/r4830_project/swift/lib/ui/screens/home_shell.dart`

Current bottom tabs (verified):
1. `Hub`
2. `Replay`
3. `Live`
4. `Telemetry`

## 5) Current UI State (Verified)
### Hub screen
- File: `/Users/globel/r4830_project/swift/lib/ui/screens/hub_screen.dart`
- Purpose: OEM-style ChargeFast control surface (`Output / Settings / Safety`).
- Contains:
  - blue OEM header and tab strip
  - row-by-row settings with per-row `Save`
  - command send wiring through `BleController.sendHex`
  - live value feed from RX logs via telemetry parser
  - explicit `TBD` behavior for unmapped rows
  - confidence-aware sends:
    - `verified` mappings send as proven payloads
    - `candidate` mappings send with candidate labeling

Naming constraint from user:
- Use `Hub` naming.
- Do not label this design as "Alipay" in app text.

### Replay flow
- Capture selection:
  - `/Users/globel/r4830_project/swift/lib/ui/screens/capture_picker_screen.dart`
  - repository scans both `../captures` and `../controller/captures`
- Session replay:
  - `/Users/globel/r4830_project/swift/lib/ui/screens/session_viewer_screen.dart`
  - `/Users/globel/r4830_project/swift/lib/domain/replay_controller.dart`
- Event list + inspector:
  - `/Users/globel/r4830_project/swift/lib/ui/widgets/event_list.dart`
  - `/Users/globel/r4830_project/swift/lib/ui/widgets/event_inspector.dart`

### Live BLE flow
- Live screen:
  - `/Users/globel/r4830_project/swift/lib/ui/screens/live_control_screen.dart`
- Controller + codec:
  - `/Users/globel/r4830_project/swift/lib/live/ble_controller.dart`
  - `/Users/globel/r4830_project/swift/lib/live/ble_codec.dart`
  - `/Users/globel/r4830_project/swift/lib/live/oem_command_mapper.dart`
  - `/Users/globel/r4830_project/swift/lib/live/payload_registry.dart`
- Registry asset:
  - `/Users/globel/r4830_project/swift/assets/payload_registry.json`
- Shared-state model:
  - One `BleController` instance is provided at app root via `provider`.
  - Hub/Live/Telemetry tabs consume the same controller instance.
- Launch gate:
  - app can require a connect dialog at startup (`HomeShell.requireConnectionOnLaunch`)
  - dialog scans for charger-like names and on connect runs `quickStart` (subscribe + keepalive)

### Telemetry tab
- File: `/Users/globel/r4830_project/swift/lib/ui/screens/telemetry_screen.dart`
- Current state:
  - live status card (connection/subscription/RX count)
  - OEM field feed card backed by decoded RX telemetry
  - latest decoded `0x06` RX values grouped by `cmd_id`
  - recent RX frame list with decoded JSON inspector
  - still evidence-driven; no hard semantic labeling without proof

## 6) BLE Data and Protocol Facts (Verified vs TBD)
### Verified from ATT JSONL pipeline
`att_events.jsonl` keys seen:
- `ts`, `flags`, `dir`, `cid`, `pb`, `bc`, `att_opcode`, `type`, `handle`, `value_hex`, `raw_hex`

Replay filters currently used:
- Telemetry: `type == ATT_HANDLE_VALUE_NTF && handle == 3`
- Commands: `type == ATT_WRITE_CMD && handle == 6`

Known capture evidence:
- Capture file exists:
  - `/Users/globel/r4830_project/controller/captures/cap_2026-02-06_03-46-28/att_events.jsonl`
- Example line count:
  - `3068`

### Verified user-observed command examples
- `06230000000023` -> manual output close
- `06230100000024` -> manual output open
- `060c010000000d` -> current-path enable
- `020606` -> observed keepalive-like TX payload

### Verified by app assets/definitions
- App payload registry contains many observed frames (`short_frames`, `frame06`, `frame05`, `raw`).
- Controller YAML also contains mapped/suspected commands with confidence labels.

### TBD / not proven
- Exact semantic decode for telemetry fields (voltage/current/temp labels not fully proven from protocol bytes).
- Definitive UUID<->handle mapping (`handle 3` and `handle 6` to specific GATT characteristics) without live proof.
- Authentication/password protocol details.

## 7) Capture and Extraction Tooling
Primary script locations:
- `/Users/globel/r4830_project/controller/backend/btsnoop_ble_extract.py`
- `/Users/globel/r4830_project/controller/backend/telemetry_extract.sh`

`telemetry_extract.sh` behavior:
- Expects `dumpstate-*.zip` (or explicit zip path).
- Fails with:
  - `ERROR: Provide a dumpstate zip or place dumpstate-*.zip in this folder.`
- Therefore replay should not depend on this script to function.

## 8) Logging and Resume Workflow
Runtime log outputs (from Live tab if logging enabled):
- JSONL: `/Users/globel/r4830_project/swift/logs/ble_events_<timestamp>.jsonl`
- Text: `/Users/globel/r4830_project/swift/logs/ble_log_<timestamp>.txt`

Resume template source:
- `/Users/globel/r4830_project/remind_codex.txt`

When resuming work, capture these four items:
1. latest JSONL log path
2. latest text log path (optional)
3. real-world connection/notification/commands summary
4. newly learned payloads/UI requests

## 9) Build, Analyze, Test Commands
From `/Users/globel/r4830_project/swift`:

Run app (macOS):
```bash
/Users/globel/flutter/bin/flutter pub get
/Users/globel/flutter/bin/flutter run -d macos
```

Standard checks:
```bash
bash /Users/globel/r4830_project/swift/scripts/run_checks.sh
```

Manual checks:
```bash
/Users/globel/flutter/bin/flutter analyze
/Users/globel/flutter/bin/flutter test
```

Current status (verified during this session):
- `flutter analyze` passes
- `flutter test` passes

## 10) Tests in Place
- `/Users/globel/r4830_project/swift/test/ble_codec_test.dart`
- `/Users/globel/r4830_project/swift/test/replay_controller_test.dart`
- `/Users/globel/r4830_project/swift/test/widget/event_list_test.dart`
- `/Users/globel/r4830_project/swift/test/widget_test.dart` (now checks Hub load)

When adding major UI widgets:
- add focused widget tests for row rendering, save button behavior, and navigation actions.

## 11) Architecture Map (Swift App)
### Data layer
- `att_event.dart` -> typed model + parser
- `capture_repository.dart` -> capture discovery + persisted last path

### Domain layer
- `replay_controller.dart` -> playback state, speed, filters

### Live layer
- `ble_controller.dart` -> scan/connect/discover/subscribe/write/keepalive/logging
- `ble_codec.dart` -> hex conversion, frame build, numeric decode helper
- `charger_telemetry.dart` -> derives latest OEM-facing values from RX logs
- `oem_command_mapper.dart` -> OEM row/action to payload mapping (verified + candidate)
- `payload_registry.dart` -> registry loader

### UI layer
- Screens under `/swift/lib/ui/screens`
- Widgets under `/swift/lib/ui/widgets`

## 12) Relationship to `agent/generated_code`
`/Users/globel/r4830_project/agent/generated_code` is a separate generated Flutter project (`chargefast_controller_app`) using Riverpod and older dependency versions.

Treat it as:
- reference code and alternate architecture
- not the currently shipping/running app by default

Do not mix code between `swift/` and `agent/generated_code/` unless explicitly requested.

## 13) OEM GUI Modeling Plan (Current Priority)
User intent:
- Start GUI work and tests from the Hub direction.
- Model behavior/layout after existing ChargeFast app screens.

Reference screen groups identified from user screenshots:
1. `Output`
2. `Settings`
3. `Safety`

### Phase A (UI skeleton, no protocol assumptions)
- Status: completed.
- `ChargeFast-style` tab shell is in place.
- Reusable row components are implemented and rendered.

### Phase B (wire to existing live/replay infrastructure)
- Status: in progress.
- Implemented:
  - Hub `Save` routes to `BleController.sendHex`.
  - Verified mappings wired (for example output path, manual control, stage2 voltage/current, power-off current, soft start).
  - Candidate mappings wired with explicit candidate messaging.
  - Unmapped rows remain `TBD` and do not guess payloads.
- Remaining:
  - confirm candidate mappings on real hardware.
  - expand verified map coverage for power/safety controls.

### Phase C (validation)
- Add widget tests for:
  - row rendering
  - value edits
  - save button callbacks
  - tab switching
- Live test with device + logging to confirm command effects.
- Added:
  - `test/oem_command_mapper_test.dart` validating payload generation for mapped commands.
  - `test/charger_telemetry_test.dart` validating RX->telemetry field extraction.

## 14) Command and Mapping Policy
- Store raw payload first.
- Only add a semantic label after reproducible evidence.
- Prefer confidence tagging: `high`, `medium`, `low`.
- For every newly mapped setting, record:
  - UI control changed
  - before/after value
  - exact payload(s)
  - capture/log file path

## 15) Operational Checklist for New Work
Before coding:
1. Run analyze/test baseline.
2. Confirm active target project (`swift/`).
3. Confirm whether task is UI-only or UI+BLE wiring.

During coding:
1. Keep replay and live tabs working.
2. Do not regress capture loading.
3. Preserve logging behavior.

After coding:
1. `flutter analyze`
2. `flutter test`
3. If BLE logic changed, run manual smoke on Live tab and note observed behavior.

## 16) Known Pitfalls
- zsh history expansion errors when pasting text with `!`.
  - Prefer script files instead of large paste blocks.
- Widget tests can fail from pending timers.
  - If using delayed animations/timers, cancel timers in `dispose()`.
- macOS sandbox can hide captures.
  - use file/folder picker fallback from Capture Picker screen.

## 17) Out-of-Scope Claims (Do Not Make)
- Do not claim final decoded telemetry semantics.
- Do not claim final auth/password protocol decode.
- Do not claim handle/UUID mapping is final without direct validation.

## 18) Definition of Done for Current Milestone
This milestone is done when:
1. Hub contains a ChargeFast-like Output/Settings/Safety interface scaffold.
2. UI rows and Save actions are test-covered.
3. Existing Replay and Live tabs still pass tests/analyze.
4. Unknown control mappings are explicitly marked `TBD`.

## 19) Fast Reference Paths
- Root guide: `/Users/globel/r4830_project/.agent.md`
- Swift app: `/Users/globel/r4830_project/swift`
- Swift README: `/Users/globel/r4830_project/swift/README.md`
- Capture folder: `/Users/globel/r4830_project/controller/captures`
- Backend extraction: `/Users/globel/r4830_project/controller/backend`
- Resume note: `/Users/globel/r4830_project/remind_codex.txt`

## 20) Session Handoff (2026-02-07)
### User-verified behavior
- `Power-on output` reads correctly from charger state when app connects.
- `Current output` state reads correctly.
- Problem observed before latest patch set: changing `Power-on output` in Hub + `Save` did not change charger state.

### Protocol evidence gathered this session
- Two-run capture diff repeatedly showed `6905` byte offset `18` flips with `Power-on output` changes.
- Polarity confirmed from user OEM behavior + diffs:
  - `6905[18] = 0` => Open
  - `6905[18] = 1` => Close
- RX/TX compare logs saved under:
  - `/Users/globel/r4830_project/swift/scripts/capture_compare_LOGS`

### Tools added/updated for reverse-engineering loop
- `/Users/globel/r4830_project/swift/scripts/two_run_rx_capture.py`
  - auto connect -> capture run1 -> disconnect -> wait for OEM-side change -> reconnect capture run2 -> disconnect
  - includes blank-password auth flow support
  - output naming: `M-D-YY-H-M-(1|2).txt`
- `/Users/globel/r4830_project/swift/scripts/rx_diff.py`
  - labels `6905` offset `18` as `power_on_output`
  - compares dominant `6905` and `3006` frames across runs

### App changes made in this session
- `Power-on output` write mapping inversion (protocol polarity fix):
  - `/Users/globel/r4830_project/swift/lib/live/oem_command_mapper.dart`
  - UI `enabled=true` (Open) now sends `060b000000000b`
  - UI `enabled=false` (Close) now sends `060b010000000c`
- Telemetry fallback decode alignment for candidate cmd frames:
  - `/Users/globel/r4830_project/swift/lib/live/charger_telemetry.dart`
  - `0x0b` decodes as `powerOnOutput` with inverted polarity (`0 => Open`)
  - `0x20` decodes as `twoStageEnabled`
- Save UX behavior adjusted:
  - `/Users/globel/r4830_project/swift/lib/ui/screens/hub_screen.dart`
  - removed immediate clearing of local toggle draft after `Save` to avoid snap-back before RX confirmation.

### Tests updated and validated
- Updated:
  - `/Users/globel/r4830_project/swift/test/oem_command_mapper_test.dart`
  - `/Users/globel/r4830_project/swift/test/charger_telemetry_test.dart`
- Verified on 2026-02-07:
  - `flutter test test/oem_command_mapper_test.dart test/charger_telemetry_test.dart` => pass
  - `flutter analyze` => pass

### Next objective when resuming
1. Launch app and connect to charger.
2. Go to `Settings`.
3. Toggle `Power-on output`.
4. Press `Save`.
5. Wait 2-3 seconds for RX refresh.
6. Confirm both:
   - charger behavior changed
   - blue `(Open)/(Close)` text reflects the new charger state.

If this still fails, capture one fresh session log in `/Users/globel/r4830_project/swift/logs` and compare TX `060b...` against resulting `6905[18]`.

## 21) Session Lockpoint (2026-02-08, NO-BACKTRACK CHECKPOINT)
This section is the current truth set and should be treated as locked unless new capture evidence proves otherwise.

### Current status
- User and capture workflow has now covered effectively all settings/buttons.
- Historical captures include both mode/language opposite-state variants; the latest single run may not contain every variant.
- Latest confirmed capture for this checkpoint:
  - `/Users/globel/r4830_project/controller/captures/raspi_snoop_2026-02-08_11-57-38`

### Confirmed command map (high confidence)
- `0x07` output voltage setpoint (float32 LE)
- `0x08` output current setpoint (float32 LE)
- `0x0B` power-on output toggle (protocol polarity inverted vs UI semantics)
- `0x0C` current output path toggle; on this firmware path `0 => Open/On`, `1 => Close/Off`
- `0x14` self-stop toggle
- `0x15` power-off current (float32 LE)
- `0x20` two-stage switch toggle
- `0x21` two-stage voltage (float32 LE)
- `0x22` two-stage current (float32 LE)
- `0x23` manual control open/close
- `0x26` soft start time (uint32 LE)
- `0x27` power limit watts (uint32 LE)
- `0x2F` multi-motor/intelligent mode toggle family

### ACK behavior (confirmed)
- RX ACK frame pattern is `03 <cmd_id> 01 <checksum>` for accepted writes.
- Confirmed examples include:
  - `03210122`, `03220123`, `03230124`, `03260127`, `03270128`, `032f0130`, `032a012b`
- Flutter app now decodes these as `frame_type: 0x03_ack` and Save UX waits for ACK before final message.

### Opposite-state payload coverage note
- `062f0100000030` and `052a7a68000c` are present in historical captures.
- The latest checkpoint run (`raspi_snoop_2026-02-08_11-57-38`) did not include every opposite-state variant.

### App code progress completed in this checkpoint
- Added ACK frame decode:
  - `/Users/globel/r4830_project/swift/lib/live/ble_codec.dart`
- Added ACK wait API + checksum gating:
  - `/Users/globel/r4830_project/swift/lib/live/ble_controller.dart`
- Hub Save now reports ACK/reject/timeout:
  - `/Users/globel/r4830_project/swift/lib/ui/screens/hub_screen.dart`
- Telemetry list now summarizes ACK frames:
  - `/Users/globel/r4830_project/swift/lib/ui/screens/telemetry_screen.dart`
- Added tests:
  - `/Users/globel/r4830_project/swift/test/ble_controller_ack_test.dart`
  - updated `/Users/globel/r4830_project/swift/test/ble_codec_test.dart`
  - updated `/Users/globel/r4830_project/swift/test/charger_telemetry_test.dart`
- Validation status at checkpoint:
  - `flutter analyze` passed
  - `flutter test` passed

### Capture tooling progress completed in this checkpoint
- Updated capture/decode script:
  - `/Users/globel/r4830_project/controller/backend/raspi_snoop_decode.sh`
- Improvements:
  - clearer command names for known IDs (`0x07`, `0x08`, `0x0b`, `0x14`, `0x27`)
  - emits ACK decode outputs:
    - `rx_ack.tsv`
    - `rx_ack_counts.tsv`

### Operational guardrail (explicit)
- Do not downgrade verified mappings to TBD unless new captures contradict them.
- Do not delete or overwrite capture artifacts under `/Users/globel/r4830_project/controller/captures`.
- Always append new findings to this file and/or `/Users/globel/r4830_project/ble_mapping_notes.txt` with exact capture path.

## 22) Functional Checkpoint (2026-02-08T20:17:23Z)
- Hub save-path audit complete: all current Save buttons now map to an actual payload path.
- Added mapping for `charging_statistics_zero` (`cmd 0x13`, payload `06130000000013`) in:
  - `/Users/globel/r4830_project/swift/lib/live/oem_command_mapper.dart`
  - `/Users/globel/r4830_project/swift/lib/ui/screens/hub_screen.dart`
- Added Save Tracking UI panel in Hub that records each save attempt result (`ACK`, `NO_ACK`, `REJECTED`, `FAILED`, `UNMAPPED`):
  - `/Users/globel/r4830_project/swift/lib/ui/screens/hub_screen.dart`
- ACK-aware save flow is active and proven in tests.
- Validation at this checkpoint:
  - `flutter analyze` passed
  - `flutter test` passed

Operational note:
- Live charger control confidence now depends primarily on RX health + ACK visibility in Save Tracking.
- If RX is increasing and Save Tracking shows `ACK`, treat that command path as actively controlled.

## 23) Web Controller Checkpoint (2026-02-08T20:32:00Z)
- Added desktop-browser Web Bluetooth app under:
  - `/Users/globel/r4830_project/controller/frontend/index.html`
  - `/Users/globel/r4830_project/controller/frontend/styles.css`
  - `/Users/globel/r4830_project/controller/frontend/app.js`
  - `/Users/globel/r4830_project/controller/frontend/README.md`
- Implemented:
  - BLE connect/disconnect and service rediscovery
  - RX notify + TX write pipeline
  - Frame builders for mapped commands (`0x06`, `0x05`)
  - ACK decode/wait flow (`0x03`) with Save Tracking statuses
  - Keepalive loop (`020606`)
  - Telemetry summary parser for known `3006` / `6905` offsets and `0x06` command echoes
- Run command:
  - `cd /Users/globel/r4830_project/controller/frontend && python3 -m http.server 8787`
  - open `http://localhost:8787` in desktop Chrome/Edge
- Validation:
  - `node --check /Users/globel/r4830_project/controller/frontend/app.js` passed

## 24) Web Identity Controls (2026-02-08T20:36:00Z)
- Added UI + handlers for:
  - Rename charger (candidate `0x1E` ASCII frame)
  - Set BLE password (candidate `0x1B` ASCII frame)
- Files updated:
  - `/Users/globel/r4830_project/controller/frontend/index.html`
  - `/Users/globel/r4830_project/controller/frontend/app.js`
  - `/Users/globel/r4830_project/controller/frontend/README.md`

## 25) Web Language Expansion (2026-02-08T20:42:00Z)
- Updated web language UI to 3 choices:
  - English
  - Chinese (Simplified)
  - Chinese (Traditional, candidate)
- Added `0x2A` candidate payload for traditional Chinese:
  - `052a7a740018` (`"zt"` + null + checksum)
- RX language decode now labels unknown two-byte language codes as:
  - `Unknown (<hexcode>)`
- Files:
  - `/Users/globel/r4830_project/controller/frontend/index.html`
  - `/Users/globel/r4830_project/controller/frontend/app.js`
  - `/Users/globel/r4830_project/controller/frontend/README.md`

## 26) Flutter UX + Password/Naming Pass (2026-02-08T20:50:00Z)
- Returned focus to Flutter Hub and improved natural-English labels across Output/Settings/Safety.
- Password update flow changes:
  - "Current Password" is now optional (supports blank-password devices).
  - If a current password is provided, app sends auth chunks before save.
  - Save still uses mapped `0x1B` password frame.
- Added ACK cmd extraction for len-prefixed ASCII frames (name/password) so Save Tracking can catch ACK if device emits one.
- Language options expanded in Flutter to:
  - English
  - Chinese (Simplified)
  - Chinese (Traditional)
- Updated mappings/parsing for language frames:
  - added traditional candidate payload `052a7a740018`
  - telemetry parser now decodes `en` / `zh` / `zt`
- Files updated:
  - `/Users/globel/r4830_project/swift/lib/ui/screens/hub_screen.dart`
  - `/Users/globel/r4830_project/swift/lib/live/oem_command_mapper.dart`
  - `/Users/globel/r4830_project/swift/lib/live/charger_telemetry.dart`
  - `/Users/globel/r4830_project/swift/test/oem_command_mapper_test.dart`
  - `/Users/globel/r4830_project/swift/test/charger_telemetry_test.dart`
  - `/Users/globel/r4830_project/controller/backend/R4830_CONTROL_SPEC.md`
  - `/Users/globel/r4830_project/controller/backend/ble_definitions.yaml`
  - `/Users/globel/r4830_project/controller/backend/controller/backend/ble_definitions.yaml`
- Validation:
  - `flutter analyze` (touched files) passed
  - `flutter test` passed

## 27) Functional Freeze Checklist Added (2026-02-08T22:05:00Z)
- Added line-by-line functional freeze checklist with per-step time estimates:
  - `/Users/globel/r4830_project/FUNCTIONAL_FREEZE_CHECKLIST.md`
- Includes:
  - ordered test steps (connection, command matrix, name/password, stability, release gate)
  - per-item pass criteria
  - total time estimates (best case / realistic / OEM fallback)
  - explicit OEM fallback triggers for password/language edge cases
- Added reference in root README:
  - `/Users/globel/r4830_project/README.md`

## 28) Checklist Split by Charging State (2026-02-08T22:12:00Z)
- Reworked functional freeze checklist into two explicit batches:
  - Batch A: no active charging / no wheel required
  - Batch B: active charging / wheel required
- Preserved original line IDs so progress remains trackable.
- Added batch subtotals and suggested execution order to minimize wheel time.
- File updated:
  - `/Users/globel/r4830_project/FUNCTIONAL_FREEZE_CHECKLIST.md`

## 29) Auto Session Init on Connect (2026-02-08T22:20:00Z)
- Updated BLE connect flow so normal operation does not require manual "Subscribe RX" or "Quick Start" click each session.
- On successful connect + service discovery, controller now auto-runs quick start (if enabled):
  - subscribe RX
  - send auth password chunks
  - send startup telemetry kick
  - start keepalive + telemetry polling
- Added toggle field for future control:
  - `autoQuickStartOnConnect` (default `true`)
- File:
  - `/Users/globel/r4830_project/swift/lib/live/ble_controller.dart`
- Validation:
  - `flutter analyze lib/live/ble_controller.dart` passed
  - `flutter test test/password_auth_test.dart test/ble_controller_ack_test.dart` passed

## 30) Power Limit "Current Value" UX Fix (2026-02-08T22:28:00Z)
- Fixed Hub display bug where the "current" Power Limit value changed as soon as the input field was edited (before Save).
- Hub now displays charger-derived power limit value from telemetry, not the unsaved text input.
- Added power-limit telemetry extraction:
  - from long `6905` frame bytes `[89..90]` (little-endian watts)
  - from command echo frame `0x27`
- Files:
  - `/Users/globel/r4830_project/swift/lib/live/charger_telemetry.dart`
  - `/Users/globel/r4830_project/swift/lib/ui/screens/hub_screen.dart`
  - `/Users/globel/r4830_project/swift/test/charger_telemetry_test.dart`
- Validation:
  - `flutter analyze` (touched files) passed
  - `flutter test test/charger_telemetry_test.dart` passed

## 31) Current Constraint Validation (2026-02-08T22:40:00Z)
- Added guardrails in Hub save validation:
  - Output Current Limit must be >= `0.3A`
  - Stage 2 Current must be >= `0.3A`
  - Stage 2 Current must be >= Power-Off Current
  - Power-Off Current cannot exceed Stage 2 Current
- File:
  - `/Users/globel/r4830_project/swift/lib/ui/screens/hub_screen.dart`
- Validation:
  - `flutter analyze lib/ui/screens/hub_screen.dart` passed
  - `flutter test test/widget_test.dart` passed

## 32) Charge Statistics Pull (Raw Counters) (2026-02-08T22:55:00Z)
- Implemented initial charge-statistics extraction and display path.
- Telemetry parser now captures two raw counters from `3006` tail bytes:
  - counter A: bytes `[40..42]` as `u24 LE`
  - counter B: bytes `[43..45]` as `u24 LE`
- Added fallback extraction from 9-byte `0000` tail notifications (for ATT-split captures):
  - counter A: bytes `[0..2]`
  - counter B: bytes `[3..5]`
- Hub "Charge Statistics" row now displays these values instead of hardcoded `--`.
- Labels explicitly mark them as raw:
  - `Charge Statistics (raw)`
- Files:
  - `/Users/globel/r4830_project/swift/lib/live/charger_telemetry.dart`
  - `/Users/globel/r4830_project/swift/lib/ui/screens/hub_screen.dart`
  - `/Users/globel/r4830_project/swift/test/charger_telemetry_test.dart`
- Validation:
  - `flutter analyze` (touched files) passed
  - `flutter test test/charger_telemetry_test.dart` passed

## 33) Strategy Naming Cleanup + Mode Sync (2026-02-09T23:09:56Z)
- Replaced confusing "Multi-Motor" UI wording with single-output-safe strategy naming while keeping command mapping on `0x2F` unchanged.
- Settings tab updates:
  - Label now `Current Strategy (Firmware)`
  - Options now `Adaptive (Intelligent)` and `Balanced (Equal Distribution)`
- Telemetry screen updates:
  - `Mode` -> `Strategy`
  - Uses same Adaptive/Balanced naming.
- Added compatibility aliases in mapper so both old and new labels still map correctly:
  - `OemCommandMapper.multiMotorMode(...)` now accepts legacy and renamed option strings.
- Synced dropdown state from telemetry so strategy/language controls reflect device-reported values during live sessions.
- Files:
  - `/Users/globel/r4830_project/swift/lib/ui/screens/hub_screen.dart`
  - `/Users/globel/r4830_project/swift/lib/ui/screens/telemetry_screen.dart`
  - `/Users/globel/r4830_project/swift/lib/live/oem_command_mapper.dart`
  - `/Users/globel/r4830_project/FUNCTIONAL_FREEZE_CHECKLIST.md`
- Validation:
  - `flutter analyze lib/ui/screens/hub_screen.dart lib/ui/screens/telemetry_screen.dart lib/live/oem_command_mapper.dart` passed
  - `flutter test test/charger_telemetry_test.dart test/widget_test.dart` passed

## 34) Output State Readback Fix (2026-02-09T23:17:52Z)
- Fixed mismatch where Hub could show `Output Enable: Enabled` while charger output is actually off.
- Telemetry decode updates:
  - Candidate output-state flags from long frames (`3006[38]`, `6905[77]`) now follow current-path semantics:
    - `0 => Open/On`
    - `1 => Close/Off`
  - Output-state source precedence now favors verified command echo (`cmd 0x0C`) over candidate long-frame flags.
- Hub UI state sync update:
  - Removed sticky optimistic override for output state; once telemetry reports output state, local override is always cleared.
- Test updates:
  - Updated long-frame output-state expectation.
  - Added regression test verifying `cmd 0x0C` output state takes precedence over candidate status flags.
- Files:
  - `/Users/globel/r4830_project/swift/lib/live/charger_telemetry.dart`
  - `/Users/globel/r4830_project/swift/lib/ui/screens/hub_screen.dart`
  - `/Users/globel/r4830_project/swift/test/charger_telemetry_test.dart`
- Validation:
  - `flutter analyze lib/live/charger_telemetry.dart lib/ui/screens/hub_screen.dart test/charger_telemetry_test.dart` passed
  - `flutter test` passed (full suite)

## 35) Startup Hydration for Output Current Input (2026-02-09T23:24:13Z)
- Fixed startup UX issue where the Output Current Limit input field could show default text instead of the charger's current limit value.
- Hub now hydrates Output Current input once per connection from telemetry:
  - preferred source: `outputSetCurrent`
  - fallback source: `outputCurrent`
- Hydration guardrails:
  - only runs while connected
  - only runs once per connection
  - does not overwrite user edits made after connect
  - resets hydration state when disconnected (next connect hydrates again)
- Added stable field key for testability:
  - `Key('output-current-limit-input')`
- Files:
  - `/Users/globel/r4830_project/swift/lib/ui/screens/hub_screen.dart`
  - `/Users/globel/r4830_project/swift/test/widget_test.dart`
- Validation:
  - `flutter analyze lib/ui/screens/hub_screen.dart test/widget_test.dart` passed
  - `flutter test test/widget_test.dart` passed
  - `flutter test` passed (full suite)

## 36) Deterministic Output Control Buttons (2026-02-09T23:27:31Z)
- Addressed user-reported issue where pressing disable did not reliably turn output off.
- Output control UI changed from a single inferred toggle to explicit command buttons:
  - `Enable Output` -> always sends `output_on` (`0x0C = 0`)
  - `Disable Output` -> always sends `output_off` (`0x0C = 1`)
- This removes dependency on possibly stale/ambiguous state inference for command direction.
- Added stable keys for controls:
  - `output-enable-btn`
  - `output-disable-btn`
- File:
  - `/Users/globel/r4830_project/swift/lib/ui/screens/hub_screen.dart`
- Validation:
  - `flutter analyze lib/ui/screens/hub_screen.dart` passed
  - `flutter test` passed (full suite)
